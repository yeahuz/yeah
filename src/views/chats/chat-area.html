<% const distinct_dates = new Map() %>
<section class="border-l border-l-gray-200 dark:border-l-zinc-800 w-full">
  <% if (it.chat) { %>
    <form method="post" action="/chats/<%= it.chat.id %>/photos" class="js-photos-link-form">
      <input type="hidden" name="chat_id" value="<%= it.chat.id %>" />
    </form>
    <form method="post" action="/chats/<%= it.chat.id %>/files" class="js-files-link-form">
    <input type="hidden" name="chat_id" value="<%= it.chat.id %>" />
    </form>
    <header class="flex justify-between w-full dark:bg-zinc-900 p-4 shadow-lg dark:drop-shadow-lg">
      <div class="flex space-x-2 items-center">
        <img src="<%= it.chat.posting.cover_url %>/width=80" class="w-12 h-12 rounded-full overflow-hidden" alt="" />
        <div class="flex flex-col">
          <a href="<%= it.chat.posting.url %>" class="underline decoration-transparent hover:decoration-white duration-200 text-gray-700 dark:text-gray-200 font-medium">
            <%= it.chat.posting.title %>
          </a>
          <a href="<%=it.chat.posting.creator.profile_url %>" class="text-gray-500 dark:text-gray-300">@<%= it.chat.posting.creator.username %></a>
        </div>
      </div>
      <div>
        <a href="/users/user-id" class="btn btn-md btn-primary">View profile</a>
      </div>
    </header>
    <div class="flex flex-col space-y-6">
      <ul class="overflow-y-auto space-y-1 flex-1 max-h-[42rem] p-4 js-messages">
        <% it.chat.messages.reverse().forEach(function (message) { %>
          <% const yyyymmdd = new Date(message.created_at).toISOString().split("T")[0] %>
          <% const existing = distinct_dates.has(yyyymmdd) %>
          <% if (!existing) distinct_dates.set(yyyymmdd, 1) %>
          <% if (!existing) { %>
            <div class="text-center py-4">
              <span class="inline-block text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full dark:bg-zinc-800 dark:text-gray-400">
                <%= yyyymmdd %>
              </span>
            </div>
          <% } %>
          <% if (message.type === "text") { %>
            <li class="p-2 rounded-lg block relative max-w-md w-fit <%= message.is_own_message ? "ml-auto text-white bg-primary-600" : "mr-auto text-gray-900 bg-gray-100 dark:text-white dark:bg-zinc-800" %>">
              <p>
                <%= message.content %>
              </p>
              <div class="flex items-center justify-end text-xs mt-0.5 space-x-1 <%= message.is_own_message ? "text-primary-50" : "text-gray-500 dark:text-gray-300" %>">
                <span>
                  <%= it.formatter.format(new Date(message.created_at)) %>
                </span>
                <% if (message.is_own_message) { %>
                  <% if (message.read_by.length > 0) {%>
                    <span class="flex">
                      <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <svg class="w-3.5 h-3.5 -ml-2.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </span>
                  <% } else { %>
                    <span>
                      <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </span>
                  <% } %>
                <% } %>
              </div>
            </li>
          <% } %>
          <% if (message.type === "photo") { %>
            <li class="w-full max-w-md ml-auto relative <%= message.is_own_message ? "ml-auto" : "mr-auto" %>">
              <ul class="flex flex-wrap justify-end gap-0.5 bg-primary-600 p-0.5 rounded-lg js-image-viewer">
                <% message.attachments.forEach(function (attachment) { %>
                  <li class="basis-40 flex-1 max-h-64 relative">
                    <span class="absolute left-1 top-1 inline-block bg-black/50 rounded-lg py-0.5 px-2 text-white text-xs"><%= it.format_bytes(attachment.size) %></span>
                    <button type="button" class="absolute top-0 left-0 w-full h-full text-white js-photo-download-btn" data-photo_url="<%= attachment.url %>">
                      <span class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/50 p-3 rounded-full inline-block pointer-events-none">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 4V20M12 20L18 14M12 20L6 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </span>
                    </button>
                    <img class="cursor-zoom-in w-full h-full object-cover align-middle rounded-lg js-zoomable" data-photo_url="<%= attachment.url %>" src="<%= attachment.url %>/width=10" crossorigin referrerpolicy="no-referrer">
                  </li>
                <% }) %>
              </ul>
            <div class="inline-flex items-center space-x-1 py-0.5 px-2 rounded-lg text-xs text-white absolute bottom-2 right-2 bg-black/50">
              <span><%= it.formatter.format(new Date(message.created_at)) %></span>
              <% if (message.is_own_message) { %>
                <% if (message.read_by.length > 0) {%>
                  <span class="flex">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <svg class="w-3.5 h-3.5 -ml-2.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                <% } else { %>
                  <span>
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </span>
                <% } %>
              <% } %>
            </div>
          </li>
          <% } %>
          <% if (message.type === "file") { %>
            <li class="p-2 max-w-md w-fit text-white flex space-x-2 items-center rounded-lg overflow-hidden <%= message.is_own_message ? "ml-auto bg-primary-600" : "bg-gray-100 dark:bg-zinc-800 mr-auto text-gray-900 dark:text-white" %>">
              <div class="relative group flex items-center justify-center w-12 h-12 flex-shrink-0 h-full">
                <a href="<%= message.attachments[0].url %>" download="<%= message.attachments[0].name %>" class="w-full opacity-0 group-hover:opacity-100 duration-200 absolute flex items-center justify-center w-full h-full text-white bg-black/50 rounded-lg js-file-download-btn">
                  <svg class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4V20M12 20L18 14M12 20L6 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
                <span class="flex w-full h-full items-center justify-center flex-shrink-0 rounded-lg
                  <%= message.is_own_message ? "bg-gray-100 text-gray-600 dark:bg-white dark:text-primary-600" : "dark:bg-zinc-700" %>">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2.26946V6.4C14 6.96005 14 7.24008 14.109 7.45399C14.2049 7.64215 14.3578 7.79513 14.546 7.89101C14.7599 8 15.0399 8 15.6 8H19.7305M20 9.98822V17.2C20 18.8802 20 19.7202 19.673 20.362C19.3854 20.9265 18.9265 21.3854 18.362 21.673C17.7202 22 16.8802 22 15.2 22H8.8C7.11984 22 6.27976 22 5.63803 21.673C5.07354 21.3854 4.6146 20.9265 4.32698 20.362C4 19.7202 4 18.8802 4 17.2V6.8C4 5.11984 4 4.27976 4.32698 3.63803C4.6146 3.07354 5.07354 2.6146 5.63803 2.32698C6.27976 2 7.11984 2 8.8 2H12.0118C12.7455 2 13.1124 2 13.4577 2.08289C13.7638 2.15638 14.0564 2.27759 14.3249 2.44208C14.6276 2.6276 14.887 2.88703 15.4059 3.40589L18.5941 6.59411C19.113 7.11297 19.3724 7.3724 19.5579 7.67515C19.7224 7.94356 19.8436 8.2362 19.9171 8.5423C20 8.88757 20 9.25445 20 9.98822Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
              </div>
              <div class="overflow-hidden">
                <a href="<%= message.attachments[0].url %>" class="underline decoration-transparent hover:decoration-white duration-300 block font-meidum text-gray-700 dark:text-gray-200 truncate"><%= message.attachments[0].name %></a>
                <div class="flex justify-between text-xs space-x-4 mt-0.5 text-primary-50">
                  <span><%= it.format_bytes(message.attachments[0].size) %></span>
                  <div class="flex items-center space-x-1">
                    <span><%= it.formatter.format(new Date(message.created_at)) %></span>
                    <% if (message.is_own_message) { %>
                      <% if (message.read_by.length > 0) {%>
                        <span class="flex">
                          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                          <svg class="w-3.5 h-3.5 -ml-2.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </span>
                      <% } else { %>
                        <span>
                          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </span>
                      <% } %>
                    <% } %>
                  </div>
                </div>
              </div>
            </li>
          <% } %>
        <% }) %>
      </ul>
      <div class="px-4 pb-4 relative js-chat-actions-container">
        <form method="post" action="/chats/hash-id" class="flex items-center space-x-2 js-message-form">
          <div>
            <input type="hidden" name="chat_id" value="<%= it.chat.id %>" />
            <label for="files" class="block text-gray-500 p-3 border border-transparent rounded-lg cursor-pointer hover:text-gray-900 hover:border-gray-300 hover:shadow-xs hover:bg-gray-50 duration-200 dark:hover:bg-zinc-800 dark:hover:text-white dark:hover:border-zinc-700">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21.1525 10.8995L12.1369 19.9151C10.0866 21.9653 6.7625 21.9653 4.71225 19.9151C2.662 17.8648 2.662 14.5407 4.71225 12.4904L13.7279 3.47483C15.0947 2.108 17.3108 2.108 18.6776 3.47483C20.0444 4.84167 20.0444 7.05775 18.6776 8.42458L10.0156 17.0866C9.33213 17.7701 8.22409 17.7701 7.54068 17.0866C6.85726 16.4032 6.85726 15.2952 7.54068 14.6118L15.1421 7.01037" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </label>
            <input type="file" name="files" id="files" value="" class="hidden js-files" multiple />
          </div>
          <elastic-textarea style="display: inline-flex"><textarea placeholder="<%= it.t("your_message", { ns: "chats" })%>" class="form-control" name="content" id="" rows="1" cols="100" tabindex=""></textarea></elastic-textarea>
          <button class="btn btn-primary btn-lg"><%= it.t("send", { ns: "chats" })%></button>
        </form>
      </div>
    </div>
  <% } else { %>
    <div class="flex items-center justify-center h-full">
      <h3 class="text-gray-700 dark:text-gray-200 text-xl font-medium"><%= it.t("select_to_see", { ns: "chats" })%></h3>
    </div>
  <% } %>
</section>
</div>
</main>
<script>
 document.title = "<%= it.t("title", { ns: "chats" }) %> | Needs"
</script>
<script defer async type="module" src="/public/js/elastic-textarea.js"></script>
<script defer async type="module" src="/public/js/chat.js"></script>
<script defer async type="module" src="/public/js/image-viewer.js"></script>
