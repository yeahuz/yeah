import { add_listeners, create_node, get_siblings } from './dom.js';import { close_icon } from './icons.js'const photos_area = document.querySelector(".js-photos-area");const photos_preview = document.querySelector(".js-photos-preview");const photos_input = document.querySelector(".js-photos-input");const preview_delete_btns = document.querySelectorAll(".js-preview-delete-btn");const preview_radio_inputs = document.querySelectorAll(".js-preview-radio-input");function on_drag_over(e) {  e.stopPropagation();  e.preventDefault();  e.dataTransfer.dropEffect = "copy";}function get_photos_preview(photos_area) {  const existing = document.querySelector(".js-photos-preview");  if (existing) return existing;  const photos_preview = create_node("ul", { class: "js-photos-preview grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-6" })  photos_area.insertAdjacentElement('beforebegin', photos_preview);  return photos_preview;}function get_file_id(file) {  return `${file.name}${file.lastModified}${file.size}`}function remove_file(file_to_remove) {  const dt = new DataTransfer();  const files = photos_input.files;  const container = get_photos_preview(photos_area);  for (const file of files) {    if (get_file_id(file) !== get_file_id(file_to_remove)) {      dt.items.add(file)    }  }  if (!dt.files.length && !container.children.length) {    container.remove();  }  photos_input.files = dt.files;}function generate_previews(files = []) {  const container = get_photos_preview(photos_area);  for (let i = 0, len = files.length; i < len; i++) {    const i_children = i + container.children.length;    const file = files[i]    const url = URL.createObjectURL(file);    const li = create_node("li", { class: "relative group rounded-lg" });    const img = create_node("img", { src: url, class: "min-h-[128px] object-fit rounded-lg aspect-video" });    const close_btn = create_node("button", { type: "button", tabindex: "0", class: `outline-none group-hover:scale-100 focus:scale-100 focus:ring-2                                          focus:ring-offset-2 focus:ring-error-500 group-focus:scale-100 md:scale-0 duration-200                                          absolute z-10 bottom-full left-full translate-y-1/2 -translate-x-1/2 bg-error-500 text-white rounded-full p-0.5` })    const radio_input = create_node("input", { type: "radio", value: i_children, name: "cover_index", id: `cover-${i_children}`, class: "absolute opacity-0 w-0 -z-10 peer", ...(i_children === 0 && { checked: true }) })    const main_label = create_node("label", { for: `cover-${i_children}`, class: `group-hover:scale-100 peer-focus:scale-100 peer-focus:ring-2                    peer-focus:ring-offset-2 peer-focus:ring-primary-600 group-focus:scale-100                    absolute bottom-0 text-xs rounded-bl-lg rounded-tr-lg bg-primary-600 text-white p-2                    peer-checked:scale-100 will-change-transform scale-0 origin-bottom-left duration-200` })    main_label.textContent = i_children === 0 ? "Обложка" : "Выбрать как обложку";    close_btn.innerHTML = close_icon({ size: 20 });    add_listeners(img, { load: () => URL.revokeObjectURL(url) })    add_listeners(close_btn, { click: () => {      li.remove();      remove_file(file);      if (radio_input.checked) {        const first_radio_input = container.querySelector("input[type=radio]");        if (first_radio_input) {          const main_label = first_radio_input.nextElementSibling;          first_radio_input.checked = true;          main_label.textContent = "Обложка";        }      }    }});    add_listeners(radio_input, {      change: on_radio_input_change,    });    li.append(img, close_btn, radio_input, main_label);    container.append(li)  }}function on_drop(e) {  e.stopPropagation();  e.preventDefault();  const files = e.dataTransfer.files;  if (e.currentTarget.classList.contains("js-photos-area")) {    photos_area.classList.remove("!border-primary-600");  }  photos_input.files = files;  generate_previews(files);}function on_drag_enter(e) {  if (e.currentTarget.classList.contains("js-photos-area")) {    photos_area.classList.add("!border-primary-600");  }}function on_drag_leave(e) {  if (e.currentTarget.classList.contains("js-photos-area")) {    photos_area.classList.remove("!border-primary-600");  }}function on_photos_change(e) {  const files = e.target.files;  if (!files.length) return;  generate_previews(files)}function on_radio_input_change(e) {  const target = e.target;  const main_label = target.nextElementSibling;  const li = target.closest("li");  const siblings = get_siblings(li);  main_label.textContent = "Обложка"  for (const sibling of siblings) {    const label = sibling.querySelector("label");    label.textContent = "Выбрать как обложку"  }}function on_existing_delete(e) {  const target = e.target;  const photo_id = target.dataset.photo_id;  const hidden_input = document.getElementById(`photos-${photo_id}`);  const li = target.closest("li");  const radio_input = li.querySelector("input[type=radio]");  li.remove();  const container = get_photos_preview(photos_area);  if (radio_input.checked) {    const first_radio_input = container.querySelector("input[type=radio]");    if (first_radio_input) {      const main_label = first_radio_input.nextElementSibling;      first_radio_input.checked = true;      main_label.textContent = "Обложка";    }  }  hidden_input.remove();  if (!container.children.length) container.remove();}add_listeners(preview_delete_btns, {  click: on_existing_delete,});add_listeners(preview_radio_inputs, {  change: on_radio_input_change,})add_listeners(photos_area, {  dragover: on_drag_over,  drop: on_drop,  dragenter: on_drag_enter,  dragleave: on_drag_leave});add_listeners(photos_input, {  change: on_photos_change});